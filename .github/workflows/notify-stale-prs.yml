name: Notify Stale PRs

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight
  workflow_dispatch:      # Allows manual triggering for testing
    inputs:
      test_mode:
        description: 'Test mode (notify all PRs regardless of age)'
        required: false
        type: boolean
        default: false

permissions:
  pull-requests: read    # Permission to read PRs
  issues: write         # Permission to create comments

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch and process PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TEST_MODE: ${{ inputs.test_mode }}
        run: |
          # Fetch PRs with proper error handling
          response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/pulls?state=open")
          
          # Check if response is empty or not valid JSON
          if ! echo "$response" | jq . >/dev/null 2>&1; then
            echo "Error: Invalid JSON response"
            exit 1
          fi
          
          # Check if response is an array (valid PR response)
          if ! echo "$response" | jq 'if type=="array" then true else false end' | grep -q true; then
            echo "Error: Unexpected response format"
            echo "$response" | jq .
            exit 1
          fi
          
          # Process each PR
          echo "$response" | jq -c '.[]' | while read -r pr; do
            created_at=$(echo "$pr" | jq -r '.created_at')
            pr_id=$(echo "$pr" | jq -r '.number')
            creator=$(echo "$pr" | jq -r '.user.login')
            
            # Calculate age in days
            age=$(( ($(date +%s) - $(date -d "$created_at" +%s)) / 86400 ))
            
            echo "Processing PR #$pr_id by $creator (age: $age days)"
            
            # Check if we should notify (either test mode is on or PR is stale)
            if [ "$TEST_MODE" = "true" ] || [ "$age" -gt 3 ]; then
              echo "PR #$pr_id meets notification criteria. Notifying..."
              curl -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/issues/$pr_id/comments" \
                -d "{\"body\": \"@$creator This PR has been open for $age days. Please provide an update on its status or any blockers preventing its completion.\"}"
            else
              echo "PR #$pr_id is not old enough for notification (age: $age days)"
            fi
          done