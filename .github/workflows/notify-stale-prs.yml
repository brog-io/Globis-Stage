name: Notify Stale PRs

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight
  workflow_dispatch:      # Allows manual triggering for testing

permissions:
  pull-requests: read    # Permission to read PRs
  issues: write         # Permission to create comments
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch and process PRs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # Fetch PRs with proper error handling
          response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/pulls?state=open")
          
          # Check if the response is an error
          if echo "$response" | jq -e 'has("message")' > /dev/null; then
            echo "Error fetching PRs: $(echo "$response" | jq -r '.message')"
            exit 1
          fi
          
          # Process each PR
          echo "$response" | jq -c '.[]' | while read -r pr; do
            created_at=$(echo "$pr" | jq -r '.created_at')
            pr_id=$(echo "$pr" | jq -r '.number')
            creator=$(echo "$pr" | jq -r '.user.login')
            
            # Calculate age in days
            age=$(( ($(date +%s) - $(date -d "$created_at" +%s)) / 86400 ))
            
            echo "Processing PR #$pr_id by $creator (age: $age days)"
            
            if [ "$age" -gt 0 ]; then
              echo "PR #$pr_id is stale. Notifying..."
              curl -X POST \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/issues/$pr_id/comments" \
                -d "{\"body\": \"@$creator This PR has been open for $age days. Please provide an update on its status or any blockers preventing its completion.\"}"
            fi
          done